Atmospherics
============

Specifically dealing with evaluating the radiative transfer for a defined set of spectra. The *wagl* package utilises `MODTRAN <http://modtran.spectral.com/>`_ for evalutating the radiative transfer.

The default number of points to evaluate the radiative transfer at is 9 for *nbar*, & 25 for *sbt*. If the *standard* model is chosen, then 25 points will be evaluated for both *nbar* and *sbt*. This is to make the workflow simpler and the output directories can be shared by both models, and share the same dependencies. The resulting *lambertian*, *nbar* and *nbart* datasets maybe slightly more accurate when using 25 points than 9 points.

Currently, the number of points are defined to cover the extents of an entire *scene*, or *granule* if the scene is *tiled*. For example a Sentinel-2a scene containing 15 granules, will subsequently have 15 * n points to evaluate the radiative transfer.

For the *nbar* model, the labels used for each radiative transfer calculation are:

    * ALBEDO-0
    * ALBEDO-1
    * ALBEDO-T

For the *sbt* model, the label used for radiative transfer calculation is:

    * ALBEDO-TH

The components for the *nbar* model are:

    * DIR:

      * Direct irradiance at the surface

    * DIF:

      * Diffuse irradiance at the surface

    * TS:

      * Direct transmittance in the solar direction

    * FV:

      * Direct fraction in the view direction; where :math:`fv = tv / (tv + tdv)`

        * TV:

          * Direct transmittance in the view direction

        * TDV:

          * Diffuse transmittance in the view direction

    * FS:

      * Direct fraction in the solar direction; where :math:`fs = ts / (ts + tds)`

        * TS:

          * Direct transmittance in the solar direction

        * TDS:

          * Diffuse transmittance in the solar direction

    * B:

      * Path radiance due to atmospheric scattering

    * S:

      * Atmospheric albedo

    * A:

      * :math:`A = (DIR + DIF) / pi * (TV + TDV)`


The coefficients for the *sbt* model are:

    * PATH-UP
    * PATH-DOWN
    * TRANSMITTANCE-UP
    * TRANSMITTANCE-DOWN

For scenes that are *tiled* such as Sentinel-2a, the ancillary data used for input into the radiative transfer calculation, are averaged. This is to get around higher resolution datasets, as well as the low resolution ancillary.

For the *sbt* model, ancillary data is gathered at each point. This is different to the *nbar* model which (depending on the ancillary) is gathered at a single location, such as the scene centre, and used for input into each point location for the radiative transfer calculations.


Radiative transfer outputs (MODTRAN)
------------------------------------

The outputs from MODTRAN, when run via *wagl*, are converted from raw binary FORTRAN records into tables, for each point, for each albedo id (0, 1, t, th). The table names for the nbar model are:

* /ALTITUDES
* /CHANNEL
* /FLUX
* /SOLAR-IRRADIANCE

And the table names for the sbt model are:

* /UPWARD-RADIATION-CHANNEL
* /DOWNWARD-RADIATION-CHANNEL


NBAR Flux Tables
~~~~~~~~~~~~~~~~

Albedo id's 0, 1 & t
^^^^^^^^^^^^^^^^^^^^

**Note**; This represents the table structure only, the values might be different between Alebedo id's.

The first 10 rows of data are:

+------------+-------+----------------+------------------+--------------+
| wavelength | level | upward_diffuse | downward_diffuse | direct_solar |
+============+=======+================+==================+==============+
| 350        | 0     | 5.826921e-12   | 0.000026         | 0.000047     |
+------------+-------+----------------+------------------+--------------+
| 350        | 1     | 3.527054e-06   | 0.000026         | 0.000052     |
+------------+-------+----------------+------------------+--------------+
| 350        | 2     | 6.470059e-06   | 0.000025         | 0.000055     |
+------------+-------+----------------+------------------+--------------+
| 350        | 3     | 8.992295e-06   | 0.000024         | 0.000059     |
+------------+-------+----------------+------------------+--------------+
| 350        | 4     | 1.120117e-05   | 0.000022         | 0.000063     |
+------------+-------+----------------+------------------+--------------+
| 350        | 5     | 1.317290e-05   | 0.000021         | 0.000066     |
+------------+-------+----------------+------------------+--------------+
| 350        | 6     | 1.490633e-05   | 0.000019         | 0.000070     |
+------------+-------+----------------+------------------+--------------+
| 350        | 7     | 1.639941e-05   | 0.000017         | 0.000074     |
+------------+-------+----------------+------------------+--------------+
| 350        | 8     | 1.767662e-05   | 0.000015         | 0.000077     |
+------------+-------+----------------+------------------+--------------+
| 350        | 9     | 1.876851e-05   | 0.000013         | 0.000079     |
+------------+-------+----------------+------------------+--------------+


NBAR Solar Irradiance Tables
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The solar irradiance tables output by MODTRAN are stored by *wagl* using the following structures:

Albedo id's 0 & 1
^^^^^^^^^^^^^^^^^

**Note**; This represents the table structure only, the values might be different between Alebedo id's.

+--------+--------------+----------+------------+
| index  | diffuse      | direct   | direct_top |
+========+==============+==========+============+
| BAND-1 | 3.538757e-05 | 0.000041 | 0.000082   |
+--------+--------------+----------+------------+
| BAND-2 | 3.132190e-05 | 0.000052 | 0.000089   |
+--------+--------------+----------+------------+
| BAND-3 | 1.877508e-05 | 0.000055 | 0.000083   |
+--------+--------------+----------+------------+
| BAND-4 | 1.109452e-05 | 0.000053 | 0.000069   |
+--------+--------------+----------+------------+
| BAND-5 | 3.657224e-06 | 0.000038 | 0.000042   |
+--------+--------------+----------+------------+
| BAND-6 | 1.867395e-07 | 0.000010 | 0.000011   |
+--------+--------------+----------+------------+
| BAND-7 | 2.551867e-08 | 0.000003 | 0.000004   |
+--------+--------------+----------+------------+
| BAND-8 | 1.633472e-05 | 0.000054 | 0.000078   |
+--------+--------------+----------+------------+

Albedo id 't'
^^^^^^^^^^^^^

+--------+--------------+----------+-------------+------------+---------------+
| index  | diffuse      | direct   | diffuse_top | direct_top | transmittance |
+========+==============+==========+=============+============+===============+
| BAND-1 | 2.709969e-05 | 0.000129 | 0.0         | 0.000178   | 0.879114      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-2 | 2.393534e-05 | 0.000150 | 0.0         | 0.000193   | 0.903089      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-3 | 1.502591e-05 | 0.000148 | 0.0         | 0.000179   | 0.912310      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-4 | 8.961730e-06 | 0.000133 | 0.0         | 0.000150   | 0.943393      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-5 | 2.975956e-06 | 0.000087 | 0.0         | 0.000091   | 0.984325      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-6 | 1.699783e-07 | 0.000022 | 0.0         | 0.000023   | 0.971214      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-7 | 2.453214e-08 | 0.000007 | 0.0         | 0.000008   | 0.946506      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND-8 | 1.305778e-05 | 0.000142 | 0.0         | 0.000168   | 0.921357      |
+--------+--------------+----------+-------------+------------+---------------+

SBT Upward and Downward Radiation Tables
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Upward radiation channel
^^^^^^^^^^^^^^^^^^^^^^^^

+-----------+-------------+---+----------+--------------+----------+----------+---------+
| band_name | 0           | 1 | 2        | 3            | 4        | 5        | 6       |
+===========+=============+===+==========+==============+==========+==========+=========+
| BAND-10   | 10903.61133 | 1 | 0.000002 | 1.783579e-07 | 217.3092 | 0.000103 | 48.5184 |
+-----------+-------------+---+----------+--------------+----------+----------+---------+
| BAND-11   | 12002.99512 | 2 | 0.000004 | 2.507863e-07 | 228.1817 | 0.000248 | 68.7634 |
+-----------+-------------+---+----------+--------------+----------+----------+---------+

Upward radiation channel (continued)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| band_name | 7        | 8      | 9       | 10       | 11  | 12  | 13  | 14       | 15  |
+===========+==========+========+=========+==========+=====+=====+=====+==========+=====+
| BAND-10   | 576.0195 | 8950.0 | 14050.0 | 0.000103 | 0.0 | 0.0 | 0.0 | 0.768765 | 1.0 |
+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| BAND-11   | 988.0800 | 8950.0 | 14050.0 | 0.000248 | 0.0 | 0.0 | 0.0 | 0.652540 | 1.0 |
+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+

Downward radiation channel
^^^^^^^^^^^^^^^^^^^^^^^^^^

+-----------+-------------+---+----------+--------------+----------+----------+---------+
| band_name | 0           | 1 | 2        | 3            | 4        | 5        | 6       |
+===========+=============+===+==========+==============+==========+==========+=========+
| BAND-10   | 10903.61133 | 1 | 0.000003 | 2.890165e-07 | 236.0131 | 0.000166 | 48.5184 |
+-----------+-------------+---+----------+--------------+----------+----------+---------+
| BAND-11   | 12002.99512 | 2 | 0.000006 | 3.864675e-07 | 248.4874 | 0.000382 | 68.7634 |
+-----------+-------------+---+----------+--------------+----------+----------+---------+

Downward radiation channel (continued)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| band_name | 7        | 8      | 9       | 10       | 11  | 12  | 13  | 14       | 15  |
+===========+==========+========+=========+==========+=====+=====+=====+==========+=====+
| BAND-10   | 576.0195 | 8950.0 | 14050.0 | 0.000166 | 0.0 | 0.0 | 0.0 | 0.643813 | 1.0 |
+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| BAND-11   | 988.0800 | 8950.0 | 14050.0 | 0.000382 | 0.0 | 0.0 | 0.0 | 0.505662 | 1.0 |
+-----------+----------+--------+---------+----------+-----+-----+-----+----------+-----+


Atmospheric Components Tables
-----------------------------

The table dataset names for the NBAR and SBT workflow models are:

* /ATMOSPHERIC-COMPONENTS/NBAR-COMPONENTS
* /ATMOSPHERIC-COMPONENTS/SBT-COMPONENTS

if the scene is not composed of multiple tiles/granules in which case the *coefficiencts* Group is at the root layer of the *wagl.singlefile_workflow* or the *wagl.multifile_workflow*, otherwise the *granule name* eg *S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01* would precede the *coefficients* Group in the *wagl.singlefile_workflow* like such:

* /S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01/ATMOSPHERIC-COMPONENTS/NBAR-COMPONENTS
* /S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01/ATMOSPHERIC-COMPONENTS/SBT-COMPONENTS

Additional columns not presented in the example tables below, include the
latitude and longitude and datetime of the sample. This coul


NBAR Components Table
~~~~~~~~~~~~~~~~~~~~~

The first 10 rows of data for the NBAR coefficients are:

+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| index | band_name | POINT | FS   | FV   | A      | B     | S     | DIR    | DIF    | DS   |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 0     | BAND-1    | 0     | 0.66 | 0.83 | 175.34 | 33.74 | 0.18  | 413.89 | 212.72 | 0.50 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 1     | BAND-2    | 0     | 0.73 | 0.86 | 205.23 | 26.91 | 0.14  | 520.76 | 193.18 | 0.58 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 2     | BAND-3    | 0     | 0.82 | 0.91 | 195.47 | 13.20 | 0.09  | 551.11 | 122.00 | 0.67 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 3     | BAND-4    | 0     | 0.88 | 0.94 | 182.75 | 6.50  | 0.06  | 533.51 | 75.07  | 0.77 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 4     | BAND-5    | 0     | 0.94 | 0.97 | 126.96 | 1.53  | 0.03  | 379.28 | 25.92  | 0.90 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 5     | BAND-6    | 0     | 0.99 | 0.99 | 31.35  | 0.05  | 0.004 | 99.98  | 1.44   | 0.93 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 6     | BAND-7    | 0     | 0.99 | 1.00 | 9.91   | 0.01  | 0.002 | 32.67  | 0.20   | 0.89 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 7     | BAND-8    | 0     | 0.84 | 0.92 | 189.91 | 11.19 | 0.08  | 540.72 | 106.84 | 0.70 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 8     | BAND-1    | 1     | 0.67 | 0.83 | 179.66 | 32.71 | 0.18  | 426.80 | 214.33 | 0.51 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+
| 9     | BAND-2    | 1     | 0.73 | 0.86 | 210.07 | 26.04 | 0.14  | 535.54 | 194.46 | 0.59 |
+-------+-----------+-------+------+------+--------+-------+-------+--------+--------+------+


SBT Components Table
~~~~~~~~~~~~~~~~~~~~

The first 10 rows of data for the SBT coefficients are:

+-------+-----------+-------+----------+-----------+------------------+--------------------+
| index | band_name | POINT | PATH-UP  | PATH-DOWN | TRANSMITTANCE-UP | TRANSMITTANCE-DOWN |
+=======+===========+=======+==========+===========+==================+====================+
| 0     | BAND-10   | 0     | 1.636909 | 2.668010  | 0.781590         | 0.663209           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 1     | BAND-11   | 0     | 2.332763 | 3.627675  | 0.668446         | 0.527527           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 2     | BAND-10   | 1     | 1.654217 | 2.714787  | 0.782114         | 0.661033           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 3     | BAND-11   | 1     | 2.355024 | 3.677702  | 0.669172         | 0.525138           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 4     | BAND-10   | 2     | 1.637271 | 2.692097  | 0.786132         | 0.665885           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 5     | BAND-11   | 2     | 2.336454 | 3.650324  | 0.674382         | 0.530870           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 6     | BAND-10   | 3     | 1.646038 | 2.698222  | 0.786254         | 0.666608           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 7     | BAND-11   | 3     | 2.347273 | 3.654962  | 0.674669         | 0.531837           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 8     | BAND-10   | 4     | 1.723207 | 2.798703  | 0.778608         | 0.657158           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
| 9     | BAND-11   | 4     | 2.438746 | 3.761915  | 0.665208         | 0.521180           |
+-------+-----------+-------+----------+-----------+------------------+--------------------+
